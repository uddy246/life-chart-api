{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "ProfileResponse",
  "type": "object",
  "additionalProperties": false,
  "required": ["meta", "input", "systems", "intersection"],
  "properties": {
    "meta": {
      "type": "object",
      "additionalProperties": false,
      "required": ["schemaVersion", "generatedAt", "engine", "locale"],
      "properties": {
        "schemaVersion": { "type": "string", "pattern": "^\\d+\\.\\d+\\.\\d+$" },
        "generatedAt": { "type": "string", "format": "date-time" },
        "engine": {
          "type": "object",
          "additionalProperties": false,
          "required": ["name", "version"],
          "properties": {
            "name": { "type": "string" },
            "version": { "type": "string" }
          }
        },
        "locale": { "type": "string" }
      }
    },

    "input": {
      "type": "object",
      "additionalProperties": false,
      "required": ["name", "birth"],
      "properties": {
        "name": { "type": "string" },
        "birth": {
          "type": "object",
          "additionalProperties": false,
          "required": ["date", "time", "timezone", "location"],
          "properties": {
            "date": { "type": "string", "format": "date" },
            "time": {
              "type": "string",
              "pattern": "^([01]\\d|2[0-3]):[0-5]\\d(:[0-5]\\d)?$"
            },
            "timezone": { "type": "string" },
            "location": {
              "type": "object",
              "additionalProperties": false,
              "required": ["city", "region", "country", "lat", "lon"],
              "properties": {
                "city": { "type": "string" },
                "region": { "type": "string" },
                "country": { "type": "string" },
                "lat": { "type": "number", "minimum": -90, "maximum": 90 },
                "lon": { "type": "number", "minimum": -180, "maximum": 180 }
              }
            }
          }
        }
      }
    },

    "systems": {
      "type": "object",
      "additionalProperties": false,
      "required": ["western", "vedic", "chinese"],
      "properties": {
        "western": { "$ref": "./western_profile.schema.json" },
        "vedic": { "$ref": "./vedic_profile.schema.json" },
        "chinese": { "$ref": "./chinese_profile.schema.json" },

        "numerology": {
          "type": "object",
          "description": "Numerology schema can be added later; kept permissive for now.",
          "additionalProperties": true
        }
      }
    },

    "intersection": {
      "type": "object",
      "additionalProperties": false,
      "required": ["convergences", "divergences", "bridgeTags", "summary"],
      "properties": {
        "convergences": { "type": "array", "items": { "$ref": "#/$defs/convergence" } },
        "divergences": { "type": "array", "items": { "$ref": "#/$defs/divergence" } },
        "bridgeTags": { "type": "array", "items": { "type": "string" } },
        "summary": {
          "type": "object",
          "additionalProperties": false,
          "required": ["headline", "notes", "nextActions"],
          "properties": {
            "headline": { "type": "string" },
            "notes": { "type": "array", "items": { "type": "string" } },
            "nextActions": { "type": "array", "items": { "type": "string" } }
          }
        }
      }
    }
  },

  "$defs": {
    "systemKey": {
      "type": "string",
      "enum": ["western", "vedic", "chinese", "numerology"]
    },

    "evidenceItem": {
      "type": "object",
      "additionalProperties": false,
      "required": ["system", "key", "note"],
      "properties": {
        "system": { "$ref": "#/$defs/systemKey" },
        "key": { "type": "string", "description": "Pointer-like key, e.g. vedic.planets.saturn.house" },
        "note": { "type": "string" }
      }
    },

    "convergence": {
      "type": "object",
      "additionalProperties": false,
      "required": ["systems", "signal", "confidence", "note", "evidence"],
      "properties": {
        "systems": {
          "type": "array",
          "items": { "$ref": "#/$defs/systemKey" },
          "minItems": 2
        },
        "signal": { "type": "string" },
        "confidence": { "type": "number", "minimum": 0, "maximum": 1 },
        "note": { "type": "string" },
        "evidence": { "type": "array", "items": { "$ref": "#/$defs/evidenceItem" } }
      }
    },

    "divergence": {
      "type": "object",
      "additionalProperties": false,
      "required": ["systems", "signal", "note", "evidence"],
      "properties": {
        "systems": {
          "type": "array",
          "items": { "$ref": "#/$defs/systemKey" },
          "minItems": 2
        },
        "signal": { "type": "string" },
        "note": { "type": "string" },
        "evidence": { "type": "array", "items": { "$ref": "#/$defs/evidenceItem" } }
      }
    }
  }
}
